---
title: "shiny-dashboards"
author: "Sven Nekula, Minke Preckel, Joshua Simon"
date: "15 6 2021"
output: html_document
runtime: shiny
bibliography: literature.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Introduction - What is Shiny?

Shiny is an R package that allows the user to create interactive web apps. Just like other [popular R packages](https://www.rstudio.com/products/rpackages/){target="_blank"}, including the tidyverse packages, it was created by members of the RStudio team and was first released as version 0.2.3 on December 1st 2012. The most current version is 1.6.0 and was released on January 25th 2021. Further information on the current and past versions can be found [here](https://www.rdocumentation.org/packages/shiny/versions/1.6.0){target="_blank"}.

Before the package was released, it was more difficult for R users to create web apps. Either there was the possibility to work with the tcltk package which was announced in 2001 and is also a graphic user interface (GUI) but with [different shortcomings](https://www.r-project.org/conferences/DSC-2001/Proceedings/Dalgaard.pdf){target=”_blank”} or it required knowledge of HTML, CSS and JavaScript. Furthermore, this required the user to carefully analyze the interaction flows and dependencies of their code to prevent unrelated outputs to change, when some input changes.
Shiny solves those problems by providing user interface (UI) functions that generate the needed HTML, CSS and JavaScript, which means that the user doesn't have to have any knowledge on these, if they don't want to go beyond the provided basics.
It also introduced a new style of programming. **_Reactive programming_** keeps track of the dependencies in the code, which enables Shiny to be able to automatically figure out, how to do most efficiently update the output, if the input changes [@WICKHAM.2021].

Shiny is used to create dashboards that replace hundreds of PDFs by allowing the user to immediately jump to the slice of data they are interested in and make it easy to communicate complex models to a nontechnical audience and visualize the data accordingly [-@WICKHAM.2021]. Shiny can also be used to create interactive documents such as this one, by adding <code>runtime: shiny</code> in the document's YAML header.

## Motivation etc - PLACEHOLDER

# 2. Structure of a Shiny app

In this section we will show the structure behind apps that are created with Shiny. Before users can start to work with Shiny, they have to install and load the package.

```{r, message=FALSE, warning=FALSE}
# Installing Shiny
if (!require("shiny")) install.packages("shiny")

# Loading Shiny
library(shiny)
```

A Shiny app essentially consists of two components, each of which can be implemented as a function in R. The first one being the UI function containing everything in terms of app layout, themes and control elements. This part of the app will be covered in section 2.1. The second part of a Shiny app consists of yet another function, the so called server function. All server-side tasks are carried out here. This includes, for example, generating outputs and handling user inputs. Section 2.2 deals with this part of the app. The code of these two components can be placed inside a single file, <code>app.R</code>. This file must return an object created by the<code>shinyApp()</code> function. However, for larger applications an individual <code>ui.R</code> and <code>server.R</code> file can be used, to give the code base a cleaner structure. The following examples shows the code layout and function calls for a standalone Shiny app implemented in a single <code>app.R</code> file.

```{r, results='hide', message=FALSE, warning=FALSE}
# Define UI for application. 
# Here, a fluid Page layout is used.
ui <- fluidPage(
  # code for ui layout
)

# Define server logic as function of inputs and outputs.
server <- function(input, output) {
  # code for server logic
}

# Run the shiny application.
shinyApp(ui = ui, server = server)

```

## 2.1 Adding controls - UI

There are three groups of functions that can be used to design the user interface of a Shiny app. The first group of functions are the UI Layout functions which are used for laying out the user interface for the application. Users can decide if they want a page with a fixed layout using <code>fixedPage</code> or a fluid layout using <code>fluidPage</code>, create icons using <code>icon</code> or create a panel containing an application title using <code>titlePanel</code> for example.  

The second group of functions are the UI Input functions. These functions are used to create user interface elements that prompt the user for input values or interaction, such as checkboxes, sliders or drop-down menus for example.

```{r, echo=FALSE}
checkboxInput("example1", "checkbox", FALSE)
selectInput("example2", label = "drop-down-menu",
              choices = c("A", "B", "C", "D"), selected = "A")
sliderInput("example3", label = "slider",
              min = 0, max = 2, value = 1, step = 0.1)
```

The last group of functions are the UI output functions. They create user interface elements that, in conjunction from server side rendering function display different kinds of output from the application, like plots or tables.

## 2.2 Adding behavior - server

The server function brings the output of the app to life by telling Shiny how to perform computations, for example how to fill a plot or a table with data. The full documentation of all the functions can be found [here](https://shiny.rstudio.com/reference/shiny/1.6.0/){target="_blank"}.

#### Extra: Using Shiny in documents - interactive documents

There are two ways to include interactive Shiny elements in a document. You can either directly add widgets and rendered output in the document or you can embed a standalone Shiny app within the document [@GROLEMUND.2014; @Xie.2019].

## 2.3 Deploying the app

After one has completed the work on an app, the question of how the software can go into production in order to reach the users must be answered. Shiny and RStudio are therefore offering a few solutions. The simplest way of running a R Shiny app is by doing it locally on your own computer. Here, a R and Shiny installation are required. A more common solution is to deploy the Shiny app to the web. The advantages of this option are that one can reach a larger target group and that end users only need a web browser to run the app. Rolling out on a server can be done using the ShinyServer software from RStudio. A Linux server or cloud-based Linux server is required for this. A simpler solution can be achieved via Shinyapps.io, a cloud hosting services by RStudio. This has the advantage that the developer doesn't need to take care of the hardware and the installation of the server. Only the app code needs to be transferred to the Shinyapps.io service. There are different price models for this deploying method - including a free solution. More on this topic can be found [here](https://shiny.rstudio.com/deploy/){target="_blank"}.

# 3. Examples

Shiny corona dashboard:

```{r, echo=FALSE, warning=FALSE, message=FALSE}
packages <- c("DT", "htmltools", "leaflet", "RColorBrewer", "sf", "shiny",
              "shinythemes", "tidyverse")

for (i in packages) { #Installs packages if not yet installed
    if(! i %in% row.names(installed.packages())) install.packages(i)
}

library(DT)
library(htmltools)
library(leaflet)
library(RColorBrewer)
library(sf)
library(shiny)
library(shinythemes)
library(tidyverse)

load_geodata <- function(url, save_flag=FALSE) {
  # Try to read geo data from the provided URL.
  # If reading fails, an older local copy is used.
  # Set save_flag = TRUE to replace the local copy
  # with newer data.
  tryCatch(
    expr = {
      geodata <<- read_sf(geodata_url)
    }, 
    error = function(e) {
      print(paste0("Error: Failed to read data from online source: ", geodata_url))
      print("Using local data set instead.")
      save_flag <<- FALSE
      load("geodata.RData")
      geodata <<- geodata
    },
    warning = function(w) {
      print(paste0("Warning: Failed to parse data from JSON source: ", geodata_url))
      print("Using local data set instead.")
      save_flag <<- FALSE
      load("geodata.RData")
      geodata <<- geodata
    }
  )
  
  if (save_flag) {
    # Saving data object in RData format.
    save(geodata, file = "geodata.RData")
  }
}


# Get geo data from online source.
geodata_url <- "https://opendata.arcgis.com/datasets/917fc37a709542548cc3be077a786c17_0.geojson"
load_geodata(geodata_url, save_flag = FALSE)


#color-palette for polygons (leaflet map)
pal <-colorNumeric(
  palette = "YlGn",
  domain = geodata$cases7_per_100k,
  reverse = T
)


#labels for polygons (leaflet map)
labs <- as.list(paste0("<b>Informations</b> <br>", 
                       "<b>Name:</b> ", geodata$GEN, "<br>",
                       "<b>Population:</b> ", geodata$EWZ, "<br>",
                       "<b>State:</b> ", geodata$BL, "<br>",
                       "<b>Cases per 100.000 (7 Days):</b> ", round(geodata$cases7_per_100k,2), "<br>",
                       "<b>Cases (total):</b> ", geodata$cases, "<br>",
                       "<b>Deaths (total):</b> ", geodata$deaths))


#Bundeslaender for selectInput()
bl <- sort(unique(geodata$BL))

#subset geodata for easier use
gdata <- geodata %>% as_tibble() %>% 
  select(c(BL, EWZ_BL, BEZ, GEN, EWZ, cases, cases_per_100k, 
           cases7_per_100k, deaths, death_rate))

shinyApp(
  
  ui = navbarPage(theme = shinytheme("flatly"), 
                 "Covid-19 in Germany",
                 tabPanel("Map",
                          fillPage(
                            leafletOutput("c19map", height = 1000)
                            )
                          ),
                 tabPanel("Table",
                          fluidPage(
                            DTOutput("tbl"),
                            style = "height:1000px; overflow-y: scroll;overflow-x: scroll;"
                            )
                          ),
                 tabPanel("Plots",
                          fluidRow(
                            column(6,
                                   selectInput("region", 
                                               label = "Choose a state of Germany", 
                                               choices = c("Germany (total)", bl),
                                               selected = "Germany (total)"))
                            ),
                          fluidRow(column(4,
                                          plotOutput("piechart"),
                                          plotOutput("c7_hi")),
                                   column(4,
                                          plotOutput("c_hi"),
                                          plotOutput("c_lo")),
                                   column(4,
                                          plotOutput("d_hi"),
                                          plotOutput("d_lo"))
                            )
                          )
                        ),
  
  server <- function(input, output) {
  
  output$c19map <- renderLeaflet({
    #leaflet map
    leaflet(geodata) %>% 
      addTiles() %>% 
      addPolygons(stroke = F, smoothFactor = 0.2, fillOpacity = 0.3,
                  color = ~pal(cases7_per_100k)
      ) %>% 
      addLegend(position = "topright", pal = pal, values = ~cases7_bl_per_100k,
                title = "Cases per 100.000 (last 7 days) </br> '7-day-incidence'"
      ) %>% 
      addPolygons(stroke = T, weight = 0.5, color = "black", 
                  label = lapply(labs, HTML),
                  labelOptions = labelOptions(textsize = "12px"))
  })
  
  output$tbl <- renderDT({
    #interactive data table
    datatable(gdata %>% select(c(-2,-3)) %>% mutate(across(c(5,6,8), round, 2)),
              rownames = F,
              colnames = c("State", "County", "Population", "Cases",
                           "Cases per 100.000", "Cases per 100.000 (last 7 days)", 
                           "Deaths", "Deathrate"))
  })
  
  
  output$piechart <- renderPlot({
    #piechart
    if (input$region == "Germany (total)"){
      gdata %>% 
        mutate(sumcases = sum(cases)) %>% 
        mutate(BL = fct_lump_n(BL, n=5, w=sumcases)) %>% 
        group_by(BL) %>%
        summarise(cases_sum = sum(cases)) %>% 
        mutate(percentage = round(cases_sum/sum(cases_sum)*100, digits = 2)) %>% 
        ggplot(., aes(x="", y=percentage, fill=BL)) + 
        geom_bar(stat = "identity") +
        coord_polar("y", start = 0) +
        theme_void() + 
        theme(legend.position = "bottom", legend.direction = "horizontal") +
        scale_fill_brewer(palette = "Pastel2") +
        geom_text(aes(label=paste0(percentage, "%"), x=1.3), 
                  position = position_stack(vjust = 0.5), size=3) + 
        labs(title = "Percentage of the states in total number of cases",
             subtitle = "Top 5 and rest",
             fill = "")
    } else {
      bundesland <- input$region
      if (input$region == bundesland){
        gdata %>% mutate(BL = as.factor(ifelse(BL==bundesland, bundesland, "other"))) %>% 
          group_by(BL) %>%
          summarise(cases_sum = sum(cases)) %>% 
          mutate(percentage = round(cases_sum/sum(cases_sum)*100, digits = 2)) %>%
          ggplot(., aes(x="", y=percentage, fill=reorder(BL, percentage))) + 
          geom_bar(stat = "identity") +
          coord_polar("y", start = 0) +
          theme_void() + 
          theme(legend.position = "bottom", legend.direction = "horizontal") +
          scale_fill_brewer(palette = "Pastel2") +
          geom_text(aes(label=paste0(percentage, "%"), x=1.3), 
                    position = position_stack(vjust = 0.5), size=3) + 
          labs(title = paste("Percentage of", bundesland, "in total number of cases"),
               subtitle = "compared to all other states",
               fill = "")
      }
    }
  })
  
  
  output$c7_hi <- renderPlot({
    #plot of LKs with highest c7/100k
    if (input$region == "Germany (total)"){
      gdata %>% 
        arrange(desc(cases7_per_100k)) %>% 
        slice(1:5) %>% 
        ggplot(., aes(x=reorder(paste(BEZ, GEN), -cases7_per_100k), y=cases7_per_100k)) + 
        geom_col(aes(fill=cases7_per_100k)) + 
        scale_fill_distiller(palette = "Reds", direction = 1) +
        theme_classic() +
        theme(axis.text.x=element_text(angle=60,hjust=1)) +
        labs(title = "Cases per 100.000 (last 7 days)",
             subtitle = "Counties with the highest 7-day-incidence",  
             x="County", 
             y="", fill="Cases per 100.000") +
        scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
    } else {
      bundesland <- input$region
      if (input$region == bundesland){
        gdata %>% 
          filter(BL == bundesland) %>% 
          arrange(desc(cases7_per_100k)) %>% 
          slice(1:5) %>% 
          ggplot(., aes(x=reorder(paste(BEZ, GEN), -cases7_per_100k), y=cases7_per_100k)) + 
          geom_col(aes(fill=cases7_per_100k)) + 
          scale_fill_distiller(palette = "Reds", direction = 1) +
          theme_classic() +
          theme(axis.text.x=element_text(angle=60,hjust=1)) +
          labs(title = "Cases per 100.000 (last 7 days)",
               subtitle = "Counties with the highest 7-day-incidence", 
               x="County", 
               y="", fill="Cases per 100.000") +
          scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
      }
    }
  })
  
  output$c_hi <- renderPlot({
    #plot of LKs with highest cases
    if (input$region == "Germany (total)"){
      gdata %>% 
        arrange(desc(cases)) %>% 
        slice(1:5) %>% 
        ggplot(., aes(x=reorder(paste(BEZ, GEN), -cases), y=cases)) + 
        geom_col(aes(fill=cases)) +
        scale_fill_distiller(palette = "Reds", direction = 1) +
        theme_classic() +
        theme(axis.text.x=element_text(angle=60,hjust=1)) +
        labs(title = "Cases (total)",
             subtitle = "Counties with the highest number of cases", 
             x="County", 
             y="", fill="Total cases") +
        scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
    } else {
      bundesland <- input$region
      if (input$region == bundesland){
        gdata %>% 
          filter(BL == bundesland) %>% 
          arrange(desc(cases)) %>% 
          slice(1:5) %>% 
          ggplot(., aes(x=reorder(paste(BEZ, GEN), -cases), y=cases)) + 
          geom_col(aes(fill=cases)) +
          scale_fill_distiller(palette = "Reds", direction = 1) +
          theme_classic() +
          theme(axis.text.x=element_text(angle=60,hjust=1)) +
          labs(title = "Cases (total)",
               subtitle = "Counties with the highest number of cases", 
               x="County", 
               y="", fill="Total cases") +
          scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
      }
    }
  })
  
  output$c_lo <- renderPlot({
    #plot of LKs with lowest cases
    if (input$region == "Germany (total)"){
      gdata %>% 
        arrange(cases) %>% 
        slice(1:5) %>% 
        ggplot(., aes(x=reorder(paste(BEZ, GEN), cases), y=cases)) + 
        geom_col(aes(fill=cases)) +
        scale_fill_distiller(palette = "Greens", direction = -1) +
        theme_classic() +
        theme(axis.text.x=element_text(angle=60,hjust=1)) +
        labs(title = "Cases (total)",
             subtitle = "Counties with the lowest number of cases", 
             x="County", 
             y="", fill="Total cases") +
        scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
    } else {
      bundesland <- input$region
      if (input$region == bundesland){
        gdata %>% 
          filter(BL == bundesland) %>% 
          arrange(cases) %>% 
          slice(1:5) %>% 
          ggplot(., aes(x=reorder(paste(BEZ, GEN), cases), y=cases)) + 
          geom_col(aes(fill=cases)) +
          scale_fill_distiller(palette = "Greens", direction = -1) +
          theme_classic() +
          theme(axis.text.x=element_text(angle=60,hjust=1)) +
          labs(title = "Cases (total)",
               subtitle = "Counties with the lowest number of cases", 
               x="County", 
               y="", fill="Total cases") +
          scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
      }
    }
  })
  
  output$d_hi <- renderPlot({
    #plot of LKs with highest deaths
    if (input$region == "Germany (total)"){
      gdata %>% 
        arrange(desc(deaths)) %>% 
        slice(1:5) %>% 
        ggplot(., aes(x=reorder(paste(BEZ, GEN), -deaths), y=deaths)) + 
        geom_col(aes(fill=deaths)) +
        scale_fill_distiller(palette = "Reds", direction = 1) +
        theme_classic() +
        theme(axis.text.x=element_text(angle=60,hjust=1)) +
        labs(title = "Deaths (total)",
             subtitle = "Counties with the highest number of deaths", 
             x="County", 
             y="", fill="Total deaths") +
        scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
    } else {
      bundesland <- input$region
      if (input$region == bundesland){
        gdata %>% 
          filter(BL == bundesland) %>% 
          arrange(desc(deaths)) %>% 
          slice(1:5) %>% 
          ggplot(., aes(x=reorder(paste(BEZ, GEN), -deaths), y=deaths)) + 
          geom_col(aes(fill=deaths)) +
          scale_fill_distiller(palette = "Reds", direction = 1) +
          theme_classic() +
          theme(axis.text.x=element_text(angle=60,hjust=1)) +
          labs(title = "Deaths (total)",
               subtitle = "Counties with the highest number of deaths", x="County", 
               y="", fill="Total deaths") +
          scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
      }
    }
  })
  
  output$d_lo <- renderPlot({
    #plot of LKs with lowest deaths
    if (input$region == "Germany (total)"){
      gdata %>% 
        arrange(deaths) %>% 
        slice(1:5) %>% 
        ggplot(., aes(x=reorder(paste(BEZ, GEN), deaths), y=deaths)) + 
        geom_col(aes(fill=deaths)) +
        scale_fill_distiller(palette = "Greens", direction = -1) +
        theme_classic() +
        theme(axis.text.x=element_text(angle=60,hjust=1)) +
        labs(title = "Deaths (total)",
             subtitle = "Counties with the lowest number of deaths", 
             x="County", 
             y="", fill="Total deaths") +
        scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
    } else {
      bundesland <- input$region
      if (input$region == bundesland){
        gdata %>% 
          filter(BL == bundesland) %>% 
          arrange(deaths) %>% 
          slice(1:5) %>% 
          ggplot(., aes(x=reorder(paste(BEZ, GEN), deaths), y=deaths)) + 
          geom_col(aes(fill=deaths)) +
          scale_fill_distiller(palette = "Greens", direction = -1) +
          theme_classic() +
          theme(axis.text.x=element_text(angle=60,hjust=1)) +
          labs(title = "Deaths (total)",
               subtitle = "Counties with the lowest number of deaths", 
               x="County", 
               y="", fill="Total deaths") +
          scale_x_discrete(labels = function(x) str_wrap(x, width = 10))
      }
    }
  })
},
  
  options = list(width=1000, height=1000)  

)

```


# 4. Conclusion

# References